DECLARE @copdate CHAR(8)
SELECT TH017,TH001,TH002,TG003,TG023,TH004 SKU,B.MB002 Name,TH008 QTY_SKU,MD003 PartID,C.MB002 Description,(TH008*MD006/MD007)
	QTY,TD010 PO_Price,ISNULL((select TOP 1 P.MB011 FROM HSWJDB..PURMB P WHERE P.MB001=MD003 AND P.MB002=TC004 ORDER BY P.MB014),
        (
        SELECT MB.MB011 FROM PURMB MB
INNER JOIN (select MB001,MIN(abs(DATEDIFF(DD, @copdate,MB008))) as minprice FROM PURMB GROUP BY MB001) AS MP
ON MP.MB001=MB.MB001 AND abs(datediff(dd,@copdate,MB008))=MP.minprice
WHERE MB.MB001=MD003 ) )AS Stand_price 
FROM COPTH TH
LEFT JOIN COPTG TG ON TG001=TH001 AND TG002=TH002
LEFT JOIN HSWJDB..BOMMD ON MD001=TH004
LEFT JOIN INVMB C ON C.MB001=MD003
LEFT JOIN INVMB B ON B.MB001=TH004
LEFT JOIN HSWJDB..PURTD ON TD004=MD003 AND TD022=TH017
LEFT JOIN HSWJDB..PURTC ON TC001=TD001 AND TC002=TD002
WHERE TH017='HBR116' --TH020='Y'